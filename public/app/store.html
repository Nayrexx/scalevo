<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Boutique ‚Äî Scalevo</title>
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/dashboard.css">
</head>
<body>
  <div class="dashboard-layout">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-logo"><span class="logo-icon">‚ö°</span> Scalevo</div>
      <nav class="sidebar-nav">
        <a href="/app/index.html" class="sidebar-link"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg> Dashboard</a>
        <a href="/app/stores.html" class="sidebar-link active"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg> Mes boutiques</a>
        <a href="/app/features.html" class="sidebar-link"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg> Modules</a>
        <a href="/app/account.html" class="sidebar-link"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> Mon compte</a>
      </nav>
      <div class="sidebar-footer">
        <button class="sidebar-link" onclick="Auth.signOut()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg> D√©connexion</button>
      </div>
    </aside>

    <main class="dashboard-main">
      <header class="topbar">
        <button class="mobile-sidebar-toggle" id="sidebarToggle"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
        <h1 class="topbar-title" id="storeName">Boutique</h1>
        <div class="topbar-right">
          <a id="topPreviewLink" href="#" target="_blank" class="btn btn-outline btn-sm" style="display:none;">Voir la boutique ‚Üó</a>
          <button id="topPublishBtn" class="btn btn-primary btn-sm" style="display:none;" onclick="togglePublish()">Publier</button>
        </div>
      </header>

      <div class="dashboard-content">
        <div class="loading-spinner" id="loader"><div class="spinner"></div></div>

        <!-- STORE HEADER BANNER -->
        <div class="store-banner" id="storeBanner" style="display:none;">
          <div class="store-banner-info">
            <div class="store-banner-icon" id="storeBannerIcon">üè™</div>
            <div>
              <h2 class="store-banner-name" id="storeBannerName">Boutique</h2>
              <span class="store-banner-url" id="storeBannerUrl">‚Äî</span>
            </div>
          </div>
          <div class="store-banner-actions">
            <span class="badge" id="storeBannerStatus">Brouillon</span>
            <a id="previewLink" href="#" target="_blank" class="btn btn-outline btn-sm" title="Pr√©visualiser m√™me si non publi√©e">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
              Pr√©visualiser
            </a>
            <a id="liveLink" href="#" target="_blank" class="btn btn-outline btn-sm" style="display:none;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
              Voir en ligne ‚Üó
            </a>
            <button id="publishBtn" class="btn btn-primary btn-sm" onclick="togglePublish()">Publier</button>
          </div>
        </div>

        <!-- ONBOARDING CHECKLIST -->
        <div class="onboarding-checklist" id="onboarding" style="display:none;">
          <div class="onboarding-header">
            <h3><span>üéØ</span> Configure ta boutique</h3>
            <span class="onboarding-progress" id="onboardingProgress">0/4</span>
          </div>
          <div class="onboarding-bar">
            <div class="onboarding-bar-fill" id="onboardingBar" style="width:0%"></div>
          </div>
          <div class="onboarding-steps">
            <div class="onboarding-step completed" id="obStep1">
              <div class="onboarding-check">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
              </div>
              <div class="onboarding-step-text">
                <strong>Cr√©er la boutique</strong>
                <span>Nom, URL, design</span>
              </div>
              <svg class="onboarding-step-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
            </div>
            <div class="onboarding-step" id="obStep2" onclick="switchToTab('settings')">
              <div class="onboarding-check">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
              </div>
              <div class="onboarding-step-text">
                <strong>Connecter Stripe</strong>
                <span>Pour recevoir les paiements</span>
              </div>
              <svg class="onboarding-step-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
            </div>
            <div class="onboarding-step" id="obStep3" onclick="showProductModal()">
              <div class="onboarding-check">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
              </div>
              <div class="onboarding-step-text">
                <strong>Ajouter un produit</strong>
                <span>Nom, prix, images, description</span>
              </div>
              <svg class="onboarding-step-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
            </div>
            <div class="onboarding-step" id="obStep4" onclick="togglePublish()">
              <div class="onboarding-check">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
              </div>
              <div class="onboarding-step-text">
                <strong>Publier ta boutique</strong>
                <span>Un clic et tu es en ligne !</span>
              </div>
              <svg class="onboarding-step-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
            </div>
          </div>
          <div class="onboarding-dismiss">
            <button onclick="dismissOnboarding()">Masquer le guide</button>
          </div>
        </div>

        <!-- TABS -->
        <div class="tabs-bar" id="tabs" style="display:none;">
          <button class="tab-btn active" data-tab="products">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/></svg>
            Produits
          </button>
          <button class="tab-btn" data-tab="orders">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/></svg>
            Commandes
          </button>
          <button class="tab-btn" data-tab="funnel">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
            Funnel
          </button>
          <button class="tab-btn" data-tab="promos">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="5" x2="5" y2="19"/><circle cx="6.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></svg>
            Promos
          </button>
          <button class="tab-btn" data-tab="analytics">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg>
            Analytics
          </button>
          <button class="tab-btn" data-tab="settings">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
            Param√®tres
          </button>
        </div>

        <!-- TAB: PRODUCTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <div class="tab-content active" id="tab-products" style="display:none;">
          <div class="tab-header">
            <div>
              <h3>Produits</h3>
              <p class="text-muted text-sm">G√®re les articles de ta boutique</p>
            </div>
            <button class="btn btn-primary btn-sm" id="addProductBtn" onclick="showProductModal()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Ajouter un produit
            </button>
          </div>
          <div id="productsList"></div>
          <div id="noProducts" class="empty-state-v2" style="display:none;">
            <div class="empty-icon">üì¶</div>
            <h3>Aucun produit pour le moment</h3>
            <p>Ajoute ton premier produit pour commencer √† vendre.</p>
            <button class="btn btn-primary" onclick="showProductModal()">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Ajouter mon premier produit
            </button>
          </div>
        </div>

        <!-- TAB: ORDERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <div class="tab-content" id="tab-orders" style="display:none;">
          <div class="tab-header">
            <div>
              <h3>Commandes</h3>
              <p class="text-muted text-sm">Suivi de tes ventes en temps r√©el</p>
            </div>
            <button class="btn btn-outline btn-sm" onclick="exportOrdersCSV()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
              Exporter CSV
            </button>
          </div>
          <div class="stats-grid stats-grid--3" id="orderStats" style="margin-bottom:1.5rem;">
            <div class="stat-card">
              <div class="stat-icon">üõí</div>
              <div class="stat-label">Total commandes</div>
              <div class="stat-value" id="oTotalOrders">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üí∞</div>
              <div class="stat-label">Revenus total</div>
              <div class="stat-value" id="oTotalRevenue">0 ‚Ç¨</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üìä</div>
              <div class="stat-label">Panier moyen</div>
              <div class="stat-value" id="oAvgOrder">0 ‚Ç¨</div>
            </div>
          </div>
          <div id="ordersTable"></div>
          <div id="noOrders" class="empty-state-v2" style="display:none;">
            <div class="empty-icon">üìã</div>
            <h3>Aucune commande</h3>
            <p>Les commandes appara√Ætront ici d√®s qu'un client ach√®tera.</p>
          </div>
        </div>

        <!-- TAB: FUNNEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <div class="tab-content" id="tab-funnel" style="display:none;">
          <h3 style="margin-bottom:1rem;">Configuration du funnel</h3>
          <div class="card" style="max-width:700px;">
            <div class="card-body">
              <form id="funnelForm">
                <h4 style="margin-bottom:1rem;">Bundles (offres group√©es)</h4>
                <div id="bundlesContainer"></div>
                <button type="button" class="btn btn-outline btn-sm" onclick="addBundle()" style="margin-bottom:2rem;">+ Ajouter un bundle</button>

                <h4 style="margin-bottom:1rem;">Order Bump</h4>
                <div class="form-group" style="margin-bottom:1rem;">
                  <label class="form-label">Titre du bump</label>
                  <input type="text" id="bumpTitle" class="input" placeholder="Ajouter une garantie √©tendue">
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-bottom:2rem;">
                  <div class="form-group">
                    <label class="form-label">Prix du bump (‚Ç¨)</label>
                    <input type="number" id="bumpPrice" class="input" step="0.01" placeholder="9.99">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" id="bumpDesc" class="input" placeholder="Garantie 2 ans">
                  </div>
                </div>

                <h4 style="margin-bottom:1rem;">Upsell post-achat</h4>
                <div class="form-group" style="margin-bottom:1rem;">
                  <label class="form-label">Titre de l'upsell</label>
                  <input type="text" id="upsellTitle" class="input" placeholder="Offre sp√©ciale !">
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-bottom:1rem;">
                  <div class="form-group">
                    <label class="form-label">Prix upsell (‚Ç¨)</label>
                    <input type="number" id="upsellPrice" class="input" step="0.01" placeholder="19.99">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" id="upsellDesc" class="input" placeholder="Pack premium...">
                  </div>
                </div>

                <h4 style="margin-bottom:1rem;">Countdown</h4>
                <div class="form-group" style="margin-bottom:1.5rem;">
                  <label class="form-label">Dur√©e du countdown (minutes)</label>
                  <input type="number" id="countdownMinutes" class="input" placeholder="15" value="15">
                </div>

                <button type="submit" class="btn btn-primary">Sauvegarder le funnel</button>
              </form>
            </div>
          </div>
        </div>

        <!-- TAB: PROMOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <div class="tab-content" id="tab-promos" style="display:none;">
          <div class="tab-header">
            <div>
              <h3>Codes promo</h3>
              <p class="text-muted text-sm">Cr√©e des r√©ductions pour booster tes ventes</p>
            </div>
            <button class="btn btn-primary btn-sm" onclick="showPromoModal()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Nouveau code
            </button>
          </div>
          <div id="promosList"></div>
          <div id="noPromos" class="empty-state-v2" style="display:none;">
            <div class="empty-icon">üè∑Ô∏è</div>
            <h3>Aucun code promo</h3>
            <p>Cr√©e ton premier code promo pour attirer des clients.</p>
            <button class="btn btn-primary" onclick="showPromoModal()">Cr√©er un code promo</button>
          </div>
        </div>

        <!-- TAB: ANALYTICS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <div class="tab-content" id="tab-analytics" style="display:none;">
          <div class="tab-header">
            <div>
              <h3>Analytics</h3>
              <p class="text-muted text-sm">Statistiques de ta boutique</p>
            </div>
          </div>
          <div class="stats-grid stats-grid--3" style="margin-bottom:1.5rem;">
            <div class="stat-card">
              <div class="stat-icon">üëÅÔ∏è</div>
              <div class="stat-label">Vues (30j)</div>
              <div class="stat-value" id="analyticsViews">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üõí</div>
              <div class="stat-label">Commandes (30j)</div>
              <div class="stat-value" id="analyticsOrders">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üìà</div>
              <div class="stat-label">Taux de conversion</div>
              <div class="stat-value" id="analyticsConversion">0%</div>
            </div>
          </div>
          <div class="card">
            <div class="card-body">
              <h4 style="margin-bottom:1rem;">Vues par jour (30 derniers jours)</h4>
              <div class="analytics-chart" id="analyticsChart">
                <div class="chart-bars" id="analyticsChartBars"></div>
                <div class="chart-labels" id="analyticsChartLabels"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- TAB: SETTINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <div class="tab-content" id="tab-settings" style="display:none;">
          <div class="tab-header">
            <div>
              <h3>Param√®tres</h3>
              <p class="text-muted text-sm">Personnalise et connecte Stripe</p>
            </div>
          </div>

          <div class="settings-grid">
            <!-- General -->
            <div class="card">
              <div class="card-body">
                <div class="card-section-title">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--brand)" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
                  G√©n√©ral
                </div>
                <form id="settingsForm">
                  <div class="form-group" style="margin-bottom:1.25rem;">
                    <label class="form-label">Nom de la boutique</label>
                    <input type="text" id="settingName" class="input" required>
                  </div>
                  <div class="form-group" style="margin-bottom:1.25rem;">
                    <label class="form-label">Description</label>
                    <textarea id="settingDesc" class="input" rows="3"></textarea>
                  </div>
                  <div class="form-group" style="margin-bottom:1.5rem;">
                    <label class="form-label">Couleur principale</label>
                    <div class="color-picker-row">
                      <input type="color" id="settingColor" value="#6C5CE7" class="color-picker-input">
                      <span class="color-picker-label" id="settingColorLabel">#6C5CE7</span>
                    </div>
                  </div>
                  <div class="form-group" style="margin-bottom:1.5rem;">
                    <label class="form-label">Th√®me de la boutique</label>
                    <div class="theme-selector">
                      <label class="theme-option">
                        <input type="radio" name="storeTheme" value="classic" checked>
                        <div class="theme-preview theme-preview--classic">
                          <div class="theme-preview-bar"></div>
                          <div class="theme-preview-content"><div></div><div></div></div>
                        </div>
                        <span>Classique</span>
                      </label>
                      <label class="theme-option">
                        <input type="radio" name="storeTheme" value="minimal">
                        <div class="theme-preview theme-preview--minimal">
                          <div class="theme-preview-bar"></div>
                          <div class="theme-preview-content"><div></div><div></div></div>
                        </div>
                        <span>Minimaliste</span>
                      </label>
                      <label class="theme-option">
                        <input type="radio" name="storeTheme" value="bold">
                        <div class="theme-preview theme-preview--bold">
                          <div class="theme-preview-bar"></div>
                          <div class="theme-preview-content"><div></div><div></div></div>
                        </div>
                        <span>Bold</span>
                      </label>
                    </div>
                  </div>
                  <button type="submit" class="btn btn-primary" style="width:100%;">Sauvegarder</button>
                </form>
              </div>
            </div>

            <!-- Stripe -->
            <div class="card">
              <div class="card-body">
                <div class="card-section-title">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                  Paiement Stripe
                </div>
                <p class="text-muted text-sm" style="margin-bottom:1.25rem;">Connecte ton compte Stripe pour recevoir les paiements de tes clients.</p>
                <div class="form-group" style="margin-bottom:1.25rem;">
                  <label class="form-label">Cl√© publique <code>pk_live_...</code></label>
                  <input type="text" id="settingStripePK" class="input" placeholder="pk_live_xxx ou pk_test_xxx">
                </div>
                <div class="form-group" style="margin-bottom:1.5rem;">
                  <label class="form-label">Cl√© secr√®te <code>sk_live_...</code></label>
                  <input type="password" id="settingStripeSK" class="input" placeholder="sk_live_xxx ou sk_test_xxx">
                  <small class="text-muted">Jamais expos√©e c√¥t√© client.</small>
                </div>
                <div class="stripe-info-box">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--brand)" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                  <span>Trouve tes cl√©s sur <a href="https://dashboard.stripe.com/apikeys" target="_blank" style="color:var(--brand);text-decoration:underline;">dashboard.stripe.com/apikeys</a></span>
                </div>
              </div>
            </div>
          </div>

          <!-- Danger zone -->
          <div class="card danger-zone" style="margin-top:2rem;">
            <div class="card-body" style="display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap;">
              <div>
                <h4 style="color:var(--danger); margin-bottom:0.25rem;">Supprimer cette boutique</h4>
                <p class="text-muted text-sm" style="margin:0;">Cette action est irr√©versible. Tous les produits et commandes seront perdus.</p>
              </div>
              <button class="btn btn-danger" onclick="deleteStore()">Supprimer</button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- PRODUCT MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="modal-overlay" id="productModal">
    <div class="modal" style="max-width:580px;">
      <div class="modal-header">
        <h3 id="productModalTitle">Ajouter un produit</h3>
        <button class="modal-close" onclick="closeProductModal()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <form id="productForm">
        <div class="modal-body">
          <input type="hidden" id="productId">
          <div class="form-group" style="margin-bottom:1.25rem;">
            <label class="form-label">Nom du produit</label>
            <input type="text" id="prodName" class="input" required placeholder="Ex: Montre Connect√©e Pro">
          </div>
          <div class="form-group" style="margin-bottom:1.25rem;">
            <label class="form-label">Description courte</label>
            <textarea id="prodDesc" class="input" rows="3" placeholder="D√©cris ton produit en quelques lignes..."></textarea>
          </div>
          <div class="form-row" style="margin-bottom:1.25rem;">
            <div class="form-group">
              <label class="form-label">Prix de vente (‚Ç¨)</label>
              <input type="number" id="prodPrice" class="input" step="0.01" required placeholder="29.99">
            </div>
            <div class="form-group">
              <label class="form-label">Prix barr√© (‚Ç¨) <span class="text-muted">optionnel</span></label>
              <input type="number" id="prodComparePrice" class="input" step="0.01" placeholder="59.99">
            </div>
          </div>
          <div class="form-group" style="margin-bottom:1.25rem;">
            <label class="form-label">Stock disponible <span class="text-muted">optionnel ‚Äî vide = illimit√©</span></label>
            <input type="number" id="prodStock" class="input" min="0" placeholder="Ex: 50 (vide = illimit√©)">
          </div>
          <div class="form-group" style="margin-bottom:1.25rem;">
            <label class="form-label">Images (URLs, une par ligne)</label>
            <textarea id="prodImages" class="input" rows="3" placeholder="https://example.com/image1.jpg&#10;https://example.com/image2.jpg"></textarea>
          </div>
          <div class="form-group" style="margin-bottom:1.25rem;">
            <label class="form-label">Caract√©ristiques (une par ligne)</label>
            <textarea id="prodFeatures" class="input" rows="3" placeholder="‚úì Livraison gratuite&#10;‚úì Garantie 30 jours"></textarea>
          </div>
          <div class="form-group">
            <label class="toggle-label">
              <input type="checkbox" id="prodPublished" class="toggle-input">
              <span class="toggle-switch"></span>
              <span>Publi√© (visible sur la boutique)</span>
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline" onclick="closeProductModal()">Annuler</button>
          <button type="submit" class="btn btn-primary" id="productSubmitBtn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
            Sauvegarder
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- PROMO CODE MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="modal-overlay" id="promoModal">
    <div class="modal" style="max-width:480px;">
      <div class="modal-header">
        <h3 id="promoModalTitle">Nouveau code promo</h3>
        <button class="modal-close" onclick="closePromoModal()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <form id="promoForm">
        <div class="modal-body">
          <div class="form-group" style="margin-bottom:1.25rem;">
            <label class="form-label">Code</label>
            <input type="text" id="promoCode" class="input" required placeholder="Ex: BIENVENUE20" style="text-transform:uppercase;">
          </div>
          <div class="form-row" style="margin-bottom:1.25rem;">
            <div class="form-group">
              <label class="form-label">Type de r√©duction</label>
              <select id="promoType" class="input">
                <option value="percent">Pourcentage (%)</option>
                <option value="fixed">Montant fixe (‚Ç¨)</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Valeur</label>
              <input type="number" id="promoValue" class="input" step="0.01" required placeholder="20">
            </div>
          </div>
          <div class="form-row" style="margin-bottom:1.25rem;">
            <div class="form-group">
              <label class="form-label">Utilisations max <span class="text-muted">optionnel</span></label>
              <input type="number" id="promoMaxUse" class="input" min="0" placeholder="Illimit√©">
            </div>
            <div class="form-group">
              <label class="form-label">Date d'expiration <span class="text-muted">optionnel</span></label>
              <input type="date" id="promoExpiry" class="input">
            </div>
          </div>
          <div class="form-group">
            <label class="toggle-label">
              <input type="checkbox" id="promoActive" class="toggle-input" checked>
              <span class="toggle-switch"></span>
              <span>Actif</span>
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline" onclick="closePromoModal()">Annuler</button>
          <button type="submit" class="btn btn-primary">Sauvegarder</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="/js/firebase-config.js"></script>
  <script src="/js/utils.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/api.js"></script>
  <script src="/js/db.js"></script>
  <script>
    const storeId = Utils.getParam('id');
    if (!storeId) window.location.href = '/app/stores.html';

    let currentStore = null;
    let currentProducts = [];
    let currentFunnel = null;

    // ‚îÄ‚îÄ‚îÄ Sidebar / Tabs ‚îÄ‚îÄ‚îÄ
    document.getElementById('sidebarToggle').addEventListener('click', () => {
      document.getElementById('sidebar').classList.toggle('open');
      document.getElementById('sidebarOverlay').classList.toggle('visible');
    });
    document.getElementById('sidebarOverlay').addEventListener('click', () => {
      document.getElementById('sidebar').classList.remove('open');
      document.getElementById('sidebarOverlay').classList.remove('visible');
    });

    document.querySelectorAll('.tab-btn').forEach(tab => {
      tab.addEventListener('click', () => {
        switchToTab(tab.dataset.tab);
      });
    });

    function switchToTab(name) {
      document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => { c.classList.remove('active'); c.style.display = 'none'; });
      const btn = document.querySelector(`.tab-btn[data-tab="${name}"]`);
      if (btn) btn.classList.add('active');
      const target = document.getElementById('tab-' + name);
      if (target) { target.classList.add('active'); target.style.display = ''; }
    }

    // ‚îÄ‚îÄ‚îÄ Products ‚îÄ‚îÄ‚îÄ
    function renderProducts() {
      if (currentProducts.length === 0) {
        document.getElementById('noProducts').style.display = '';
        document.getElementById('productsList').innerHTML = '';
        return;
      }
      document.getElementById('noProducts').style.display = 'none';
      document.getElementById('productsList').innerHTML = currentProducts.map(p => `
        <div class="product-row">
          <div class="product-row-img">
            ${p.images && p.images[0] ? `<img src="${Utils.escapeHtml(p.images[0])}" alt="">` : '<div style="width:60px;height:60px;background:var(--bg-tertiary);border-radius:var(--radius-sm);"></div>'}
          </div>
          <div class="product-row-info">
            <strong>${Utils.escapeHtml(p.name)}</strong>
            <span>${Utils.formatPrice(p.price)}${p.comparePrice ? ' <s style="color:var(--text-secondary);">' + Utils.formatPrice(p.comparePrice) + '</s>' : ''}</span>
          </div>
          <div class="product-row-status">
            <span class="badge ${p.published ? 'badge-success' : 'badge-outline'}">${p.published ? 'Publi√©' : 'Brouillon'}</span>
            ${p.stock != null ? `<span class="badge ${p.stock <= 5 ? 'badge-danger' : 'badge-outline'}" style="margin-left:0.5rem;">Stock: ${p.stock}</span>` : ''}
          </div>
          <div class="product-row-actions">
            <button class="btn btn-outline btn-sm" onclick="editProduct('${p.id}')">Modifier</button>
            <button class="btn btn-danger btn-sm" onclick="removeProduct('${p.id}')">Supprimer</button>
          </div>
        </div>
      `).join('');
    }

    function showProductModal(product) {
      const modal = document.getElementById('productModal');
      document.getElementById('productModalTitle').textContent = product ? 'Modifier le produit' : 'Ajouter un produit';
      document.getElementById('productId').value = product?.id || '';
      document.getElementById('prodName').value = product?.name || '';
      document.getElementById('prodDesc').value = product?.description || '';
      document.getElementById('prodPrice').value = product?.price || '';
      document.getElementById('prodComparePrice').value = product?.comparePrice || '';
      document.getElementById('prodStock').value = product?.stock != null ? product.stock : '';
      document.getElementById('prodImages').value = (product?.images || []).join('\n');
      document.getElementById('prodFeatures').value = (product?.features || []).join('\n');
      document.getElementById('prodPublished').checked = product?.published || false;
      modal.classList.add('active');
    }

    function closeProductModal() {
      document.getElementById('productModal').classList.remove('active');
    }

    function editProduct(id) {
      const p = currentProducts.find(x => x.id === id);
      if (p) showProductModal(p);
    }

    async function removeProduct(id) {
      if (!confirm('Supprimer ce produit ?')) return;
      try {
        await DB.deleteProduct(storeId, id);
        currentProducts = currentProducts.filter(p => p.id !== id);
        renderProducts();
        Utils.toast('Produit supprim√©', 'success');
      } catch(e) { Utils.toast('Erreur: ' + e.message, 'error'); }
    }

    document.getElementById('productForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('productSubmitBtn');
      btn.disabled = true;
      btn.textContent = 'Sauvegarde...';

      const data = {
        name: document.getElementById('prodName').value.trim(),
        description: document.getElementById('prodDesc').value.trim(),
        price: parseFloat(document.getElementById('prodPrice').value) || 0,
        stock: document.getElementById('prodStock').value !== '' ? parseInt(document.getElementById('prodStock').value) : null,
        comparePrice: parseFloat(document.getElementById('prodComparePrice').value) || 0,
        images: document.getElementById('prodImages').value.split('\n').map(s => s.trim()).filter(Boolean),
        features: document.getElementById('prodFeatures').value.split('\n').map(s => s.trim()).filter(Boolean),
        published: document.getElementById('prodPublished').checked
      };

      const productId = document.getElementById('productId').value;
      try {
        if (productId) {
          await DB.updateProduct(storeId, productId, data);
          const idx = currentProducts.findIndex(p => p.id === productId);
          if (idx >= 0) currentProducts[idx] = { ...currentProducts[idx], ...data };
        } else {
          const newId = await DB.createProduct(storeId, data);
          currentProducts.unshift({ id: newId, ...data });
        }
        renderProducts();
        closeProductModal();
        Utils.toast('Produit sauvegard√©', 'success');
        updateOnboarding();
      } catch(e) { Utils.toast('Erreur: ' + e.message, 'error'); }
      btn.disabled = false;
      btn.textContent = 'Sauvegarder';
    });

    // ‚îÄ‚îÄ‚îÄ Orders ‚îÄ‚îÄ‚îÄ
    async function loadOrders() {
      const orders = await DB.getOrders(storeId);
      const stats = await DB.getOrderStats(storeId);
      document.getElementById('oTotalOrders').textContent = stats.totalOrders;
      document.getElementById('oTotalRevenue').textContent = Utils.formatPrice(stats.totalRevenue);
      document.getElementById('oAvgOrder').textContent = Utils.formatPrice(stats.averageOrder);

      if (orders.length === 0) {
        document.getElementById('noOrders').style.display = '';
        return;
      }
      document.getElementById('ordersTable').innerHTML = `
        <table class="table">
          <thead><tr><th>Date</th><th>Client</th><th>Montant</th><th>Statut</th></tr></thead>
          <tbody>
            ${orders.map(o => `
              <tr>
                <td>${o.createdAt?.toDate ? o.createdAt.toDate().toLocaleDateString('fr-FR') : '‚Äî'}</td>
                <td>${Utils.escapeHtml(o.customerEmail || '‚Äî')}</td>
                <td>${Utils.formatPrice(o.amount || 0)}</td>
                <td><span class="badge ${o.status === 'paid' ? 'badge-success' : o.status === 'refunded' ? 'badge-danger' : 'badge-outline'}">${o.status || 'pending'}</span></td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    // ‚îÄ‚îÄ‚îÄ Funnel ‚îÄ‚îÄ‚îÄ
    let bundleCount = 0;
    function addBundle(data) {
      bundleCount++;
      const i = bundleCount;
      const container = document.getElementById('bundlesContainer');
      const div = document.createElement('div');
      div.className = 'card';
      div.style.marginBottom = '1rem';
      div.innerHTML = `
        <div class="card-body" style="padding:1rem;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.75rem;">
            <strong>Bundle ${i}</strong>
            <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.card').remove()">√ó</button>
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.75rem;">
            <div class="form-group">
              <label class="form-label">Label</label>
              <input type="text" class="input bundle-label" value="${data?.label || ''}" placeholder="Pack x3">
            </div>
            <div class="form-group">
              <label class="form-label">Quantit√©</label>
              <input type="number" class="input bundle-qty" value="${data?.qty || 1}" min="1">
            </div>
            <div class="form-group">
              <label class="form-label">Prix unitaire (‚Ç¨)</label>
              <input type="number" class="input bundle-price" step="0.01" value="${data?.unitPrice || ''}" placeholder="24.99">
            </div>
            <div class="form-group">
              <label class="form-label">Badge</label>
              <input type="text" class="input bundle-badge" value="${data?.badge || ''}" placeholder="Meilleure vente">
            </div>
          </div>
        </div>
      `;
      container.appendChild(div);
    }

    function collectBundles() {
      const bundles = [];
      document.querySelectorAll('#bundlesContainer .card').forEach(card => {
        bundles.push({
          label: card.querySelector('.bundle-label').value.trim(),
          qty: parseInt(card.querySelector('.bundle-qty').value) || 1,
          unitPrice: parseFloat(card.querySelector('.bundle-price').value) || 0,
          badge: card.querySelector('.bundle-badge').value.trim()
        });
      });
      return bundles;
    }

    document.getElementById('funnelForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = {
        bundles: collectBundles(),
        orderBump: {
          title: document.getElementById('bumpTitle').value.trim(),
          price: parseFloat(document.getElementById('bumpPrice').value) || 0,
          description: document.getElementById('bumpDesc').value.trim()
        },
        upsell: {
          title: document.getElementById('upsellTitle').value.trim(),
          price: parseFloat(document.getElementById('upsellPrice').value) || 0,
          description: document.getElementById('upsellDesc').value.trim()
        },
        countdownMinutes: parseInt(document.getElementById('countdownMinutes').value) || 15
      };

      try {
        const id = await DB.saveFunnel(storeId, currentFunnel?.id, data);
        currentFunnel = { id, ...data };
        Utils.toast('Funnel sauvegard√©', 'success');
      } catch(e) { Utils.toast('Erreur: ' + e.message, 'error'); }
    });

    function populateFunnel(funnel) {
      if (!funnel) return;
      (funnel.bundles || []).forEach(b => addBundle(b));
      document.getElementById('bumpTitle').value = funnel.orderBump?.title || '';
      document.getElementById('bumpPrice').value = funnel.orderBump?.price || '';
      document.getElementById('bumpDesc').value = funnel.orderBump?.description || '';
      document.getElementById('upsellTitle').value = funnel.upsell?.title || '';
      document.getElementById('upsellPrice').value = funnel.upsell?.price || '';
      document.getElementById('upsellDesc').value = funnel.upsell?.description || '';
      document.getElementById('countdownMinutes').value = funnel.countdownMinutes || 15;
    }

    // ‚îÄ‚îÄ‚îÄ Settings ‚îÄ‚îÄ‚îÄ
    document.getElementById('settingColor').addEventListener('input', (e) => {
      document.getElementById('settingColorLabel').textContent = e.target.value;
    });

    document.getElementById('settingsForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const selectedTheme = document.querySelector('input[name="storeTheme"]:checked')?.value || 'classic';
        const updates = {
          name: document.getElementById('settingName').value.trim(),
          description: document.getElementById('settingDesc').value.trim(),
          primaryColor: document.getElementById('settingColor').value,
          theme: selectedTheme,
          stripePublishableKey: document.getElementById('settingStripePK').value.trim(),
          stripeSecretKey: document.getElementById('settingStripeSK').value.trim()
        };
        await API.updateStore(storeId, updates);
        currentStore = { ...currentStore, ...updates };
        document.getElementById('storeName').textContent = updates.name;
        document.getElementById('storeBannerName').textContent = updates.name;
        Utils.toast('Param√®tres sauvegard√©s', 'success');
        updateOnboarding();
      } catch(e) { Utils.toast('Erreur: ' + e.message, 'error'); }
    });

    // ‚îÄ‚îÄ‚îÄ Promo Codes ‚îÄ‚îÄ‚îÄ
    let currentPromos = [];

    function showPromoModal() {
      document.getElementById('promoCode').value = '';
      document.getElementById('promoType').value = 'percent';
      document.getElementById('promoValue').value = '';
      document.getElementById('promoMaxUse').value = '';
      document.getElementById('promoExpiry').value = '';
      document.getElementById('promoActive').checked = true;
      document.getElementById('promoModal').classList.add('active');
    }

    function closePromoModal() {
      document.getElementById('promoModal').classList.remove('active');
    }

    async function loadPromos() {
      currentPromos = await DB.getPromoCodes(storeId);
      if (currentPromos.length === 0) {
        document.getElementById('noPromos').style.display = '';
        document.getElementById('promosList').innerHTML = '';
        return;
      }
      document.getElementById('noPromos').style.display = 'none';
      document.getElementById('promosList').innerHTML = currentPromos.map(p => `
        <div class="product-row">
          <div class="product-row-info" style="flex:1;">
            <strong style="font-family:monospace; font-size:1.1rem; letter-spacing:1px;">${Utils.escapeHtml(p.code)}</strong>
            <span>${p.type === 'percent' ? p.value + '% de r√©duction' : Utils.formatPrice(p.value) + ' de r√©duction'}</span>
          </div>
          <div class="product-row-status">
            <span class="badge badge-outline">Utilis√© ${p.usageCount || 0}x${p.maxUse ? '/' + p.maxUse : ''}</span>
            <span class="badge ${p.active ? 'badge-success' : 'badge-outline'}" style="margin-left:0.5rem;">${p.active ? 'Actif' : 'Inactif'}</span>
          </div>
          <div class="product-row-actions">
            <button class="btn btn-outline btn-sm" onclick="togglePromo('${p.id}', ${!p.active})">${p.active ? 'D√©sactiver' : 'Activer'}</button>
            <button class="btn btn-danger btn-sm" onclick="removePromo('${p.id}')">Supprimer</button>
          </div>
        </div>
      `).join('');
    }

    document.getElementById('promoForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = {
        code: document.getElementById('promoCode').value.trim().toUpperCase(),
        type: document.getElementById('promoType').value,
        value: parseFloat(document.getElementById('promoValue').value) || 0,
        maxUse: parseInt(document.getElementById('promoMaxUse').value) || null,
        expiresAt: document.getElementById('promoExpiry').value || null,
        active: document.getElementById('promoActive').checked
      };
      if (!data.code || !data.value) { Utils.toast('Code et valeur requis', 'error'); return; }
      try {
        await DB.createPromoCode(storeId, data);
        closePromoModal();
        await loadPromos();
        Utils.toast('Code promo cr√©√©', 'success');
      } catch(e) { Utils.toast('Erreur: ' + e.message, 'error'); }
    });

    async function togglePromo(promoId, active) {
      try {
        await DB.updatePromoCode(storeId, promoId, { active });
        await loadPromos();
        Utils.toast(active ? 'Code activ√©' : 'Code d√©sactiv√©', 'success');
      } catch(e) { Utils.toast('Erreur: ' + e.message, 'error'); }
    }

    async function removePromo(id) {
      if (!confirm('Supprimer ce code promo ?')) return;
      try {
        await DB.deletePromoCode(storeId, id);
        await loadPromos();
        Utils.toast('Code supprim√©', 'success');
      } catch(e) { Utils.toast('Erreur: ' + e.message, 'error'); }
    }

    // ‚îÄ‚îÄ‚îÄ CSV Export ‚îÄ‚îÄ‚îÄ
    async function exportOrdersCSV() {
      const orders = await DB.getOrders(storeId, 5000);
      if (orders.length === 0) { Utils.toast('Aucune commande √† exporter', 'error'); return; }

      const headers = ['Date', 'Email client', 'Montant', 'Devise', 'Statut', 'Type'];
      const rows = orders.map(o => {
        const date = o.createdAt?.toDate ? o.createdAt.toDate().toISOString() : '';
        return [date, o.customerEmail || '', o.amount || 0, o.currency || 'EUR', o.status || 'pending', o.type || ''];
      });

      let csv = headers.join(';') + '\n';
      rows.forEach(r => { csv += r.map(v => '"' + String(v).replace(/"/g, '""') + '"').join(';') + '\n'; });

      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `commandes_${currentStore.slug}_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      Utils.toast('Export CSV t√©l√©charg√©', 'success');
    }

    // ‚îÄ‚îÄ‚îÄ Analytics ‚îÄ‚îÄ‚îÄ
    async function loadAnalytics() {
      try {
        const analytics = await DB.getAnalytics(storeId, 30);
        const orders = await DB.getOrders(storeId, 1000);
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

        const totalViews = analytics.reduce((acc, a) => acc + (a.views || 0), 0);
        const recentOrders = orders.filter(o => {
          const d = o.createdAt?.toDate?.() || new Date(o.createdAt);
          return d >= thirtyDaysAgo;
        });

        document.getElementById('analyticsViews').textContent = totalViews;
        document.getElementById('analyticsOrders').textContent = recentOrders.length;
        const conversion = totalViews > 0 ? ((recentOrders.length / totalViews) * 100).toFixed(1) : '0';
        document.getElementById('analyticsConversion').textContent = conversion + '%';

        // Build chart for last 14 days
        const dayLabels = [];
        const viewsByDay = {};
        for (let i = 13; i >= 0; i--) {
          const d = new Date();
          d.setDate(d.getDate() - i);
          const key = d.toISOString().split('T')[0];
          dayLabels.push(key);
          viewsByDay[key] = 0;
        }
        analytics.forEach(a => { if (viewsByDay[a.date] !== undefined) viewsByDay[a.date] = a.views || 0; });

        const vals = dayLabels.map(k => viewsByDay[k]);
        const maxV = Math.max(...vals, 1);
        document.getElementById('analyticsChartBars').innerHTML = vals.map(v => {
          const pct = Math.max((v / maxV) * 100, 4);
          return `<div class="chart-bar-wrap"><div class="chart-bar-value">${v > 0 ? v : ''}</div><div class="chart-bar" style="height:${pct}%"></div></div>`;
        }).join('');
        document.getElementById('analyticsChartLabels').innerHTML = dayLabels.map(k => {
          const d = new Date(k + 'T00:00:00');
          return `<span>${d.getDate()}/${d.getMonth()+1}</span>`;
        }).join('');
      } catch(e) { console.error('Analytics error:', e); }
    }

    async function deleteStore() {
      if (!confirm('Supprimer cette boutique et tous ses produits ? Cette action est irr√©versible.')) return;
      try {
        await API.deleteStore(storeId);
        Utils.toast('Boutique supprim√©e', 'success');
        window.location.href = '/app/stores.html';
      } catch(e) { Utils.toast('Erreur: ' + e.message, 'error'); }
    }

    async function togglePublish() {
      const newState = !currentStore.published;
      try {
        await DB.updateStoreLocal(storeId, { published: newState });
        currentStore.published = newState;
        document.getElementById('publishBtn').textContent = newState ? 'D√©publier' : 'Publier';
        document.getElementById('publishBtn').className = newState ? 'btn btn-outline btn-sm' : 'btn btn-primary btn-sm';
        document.getElementById('storeBannerStatus').textContent = newState ? 'En ligne' : 'Brouillon';
        document.getElementById('storeBannerStatus').className = 'badge ' + (newState ? 'badge-success' : 'badge-outline');
        // Update live link visibility
        if (newState) {
          document.getElementById('liveLink').href = 'https://' + currentStore.slug + '.' + ROOT_DOMAIN;
          document.getElementById('liveLink').style.display = '';
        } else {
          document.getElementById('liveLink').style.display = 'none';
        }
        Utils.toast(newState ? 'Boutique publi√©e !' : 'Boutique d√©publi√©e', 'success');
        updateOnboarding();
      } catch(e) { Utils.toast('Erreur: ' + e.message, 'error'); }
    }

    // ‚îÄ‚îÄ‚îÄ Onboarding Checklist ‚îÄ‚îÄ‚îÄ
    function updateOnboarding() {
      const isNew = new URLSearchParams(window.location.search).get('new') === '1';
      const dismissed = localStorage.getItem('ob_dismissed_' + storeId);
      if (dismissed && !isNew) return;

      const hasStripe = !!(currentStore.stripePublishableKey && currentStore.stripeSecretKey);
      const hasProducts = currentProducts.length > 0;
      const isPublished = currentStore.published;

      if (hasStripe && hasProducts && isPublished) {
        document.getElementById('onboarding').style.display = 'none';
        return;
      }

      document.getElementById('onboarding').style.display = '';

      let done = 1;
      if (hasStripe) { done++; document.getElementById('obStep2').classList.add('completed'); }
      if (hasProducts) { done++; document.getElementById('obStep3').classList.add('completed'); }
      if (isPublished) { done++; document.getElementById('obStep4').classList.add('completed'); }

      document.getElementById('onboardingProgress').textContent = done + '/4';
      document.getElementById('onboardingBar').style.width = (done * 25) + '%';
    }

    function dismissOnboarding() {
      localStorage.setItem('ob_dismissed_' + storeId, '1');
      document.getElementById('onboarding').style.display = 'none';
    }

    // ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ
    Auth.init(async (user) => {
      if (!user) { window.location.href = '/login.html'; return; }

      currentStore = await DB.getStore(storeId);
      if (!currentStore || currentStore.ownerId !== user.uid) {
        Utils.toast('Boutique introuvable', 'error');
        window.location.href = '/app/stores.html';
        return;
      }

      // Header banner
      document.getElementById('storeBannerName').textContent = currentStore.name;
      document.getElementById('storeBannerUrl').textContent = currentStore.slug + '.scalevo.shop';
      document.getElementById('storeBannerIcon').textContent = currentStore.name.charAt(0).toUpperCase();
      document.getElementById('storeBannerStatus').textContent = currentStore.published ? 'En ligne' : 'Brouillon';
      document.getElementById('storeBannerStatus').className = 'badge ' + (currentStore.published ? 'badge-success' : 'badge-outline');

      // Header
      document.getElementById('storeName').textContent = currentStore.name;
      // Preview link always works (even unpublished) ‚Äî uses ?preview=storeId token
      const storeUrl = 'https://' + currentStore.slug + '.' + ROOT_DOMAIN;
      document.getElementById('previewLink').href = storeUrl + '?preview=' + storeId;
      // Live link only shown when published
      if (currentStore.published) {
        document.getElementById('liveLink').href = storeUrl;
        document.getElementById('liveLink').style.display = '';
      }
      document.getElementById('publishBtn').textContent = currentStore.published ? 'D√©publier' : 'Publier';
      document.getElementById('publishBtn').className = currentStore.published ? 'btn btn-outline btn-sm' : 'btn btn-primary btn-sm';

      // Load data
      currentProducts = await DB.getProducts(storeId);
      currentFunnel = await DB.getFunnel(storeId);

      // Populate
      renderProducts();
      populateFunnel(currentFunnel);
      loadOrders();

      // Settings
      document.getElementById('settingName').value = currentStore.name || '';
      document.getElementById('settingDesc').value = currentStore.description || '';
      document.getElementById('settingColor').value = currentStore.primaryColor || '#6C5CE7';
      document.getElementById('settingColorLabel').textContent = currentStore.primaryColor || '#6C5CE7';
      document.getElementById('settingStripePK').value = currentStore.stripePublishableKey || '';
      document.getElementById('settingStripeSK').value = currentStore.stripeSecretKey ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : '';

      // Theme radio
      const themeVal = currentStore.theme || 'classic';
      const themeRadio = document.querySelector(`input[name="storeTheme"][value="${themeVal}"]`);
      if (themeRadio) themeRadio.checked = true;

      // Show UI
      document.getElementById('loader').style.display = 'none';
      document.getElementById('storeBanner').style.display = '';
      document.getElementById('tabs').style.display = '';
      document.getElementById('tab-products').style.display = '';

      // Show onboarding checklist
      updateOnboarding();

      // Load promos and analytics in background
      loadPromos();
      loadAnalytics();
    });
  </script>
</body>
</html>