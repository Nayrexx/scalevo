<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nouvelle boutique ‚Äî Scalevo</title>
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/dashboard.css">
</head>
<body>
  <div class="dashboard-layout">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-logo"><span class="logo-icon">‚ö°</span> Scalevo</div>
      <nav class="sidebar-nav">
        <a href="/app/index.html" class="sidebar-link"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg> Dashboard</a>
        <a href="/app/stores.html" class="sidebar-link active"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg> Mes boutiques</a>
        <a href="/app/account.html" class="sidebar-link"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> Mon compte</a>
      </nav>
      <div class="sidebar-footer">
        <button class="sidebar-link" onclick="Auth.signOut()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg> D√©connexion</button>
      </div>
    </aside>

    <main class="dashboard-main">
      <header class="topbar">
        <button class="mobile-sidebar-toggle" id="sidebarToggle"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
        <h1 class="topbar-title">Nouvelle boutique</h1>
        <div class="topbar-right"></div>
      </header>

      <div class="dashboard-content">
        <div class="wizard">
          <div class="wizard-container">
            <!-- PROGRESS BAR -->
            <div class="wizard-progress">
              <div class="wizard-step active" data-step="1">
                <div class="wizard-step-circle">1</div>
                <span>Identit√©</span>
              </div>
              <div class="wizard-step-line"></div>
              <div class="wizard-step" data-step="2">
                <div class="wizard-step-circle">2</div>
                <span>Configuration</span>
              </div>
              <div class="wizard-step-line"></div>
              <div class="wizard-step" data-step="3">
                <div class="wizard-step-circle">3</div>
                <span>Lancement</span>
              </div>
            </div>

            <!-- STEP 1: IDENTITY -->
            <div class="wizard-panel active" id="step1">
              <div class="wizard-panel-header">
                <span class="wizard-emoji">üè™</span>
                <h2>Donne un nom √† ta boutique</h2>
                <p class="text-muted">C'est ce que tes clients verront. Tu pourras le changer apr√®s.</p>
              </div>

              <div class="form-group" style="margin-bottom:1.5rem;">
                <label class="form-label">Nom de la boutique</label>
                <input type="text" id="storeName" class="input input-lg" placeholder="Ex: FitGear, LumiDeco, SnapCase..." required autofocus>
              </div>

              <div class="form-group" style="margin-bottom:1.5rem;">
                <label class="form-label">Adresse de ta boutique</label>
                <div class="slug-input-wrapper">
                  <input type="text" id="storeSlug" class="input input-lg" placeholder="ma-boutique" required>
                  <span class="slug-suffix">.scalevo.shop</span>
                </div>
                <div id="slugStatus" class="slug-status"></div>
              </div>

              <button type="button" class="btn btn-primary btn-lg wizard-next-btn" id="toStep2" disabled onclick="goToStep(2)">
                Continuer
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
              </button>
            </div>

            <!-- STEP 2: CONFIG -->
            <div class="wizard-panel" id="step2">
              <div class="wizard-panel-header">
                <span class="wizard-emoji">‚öôÔ∏è</span>
                <h2>Personnalise ta boutique</h2>
                <p class="text-muted">Quelques d√©tails pour bien d√©marrer.</p>
              </div>

              <div class="form-group" style="margin-bottom:1.5rem;">
                <label class="form-label">Description <span class="text-muted">(optionnel)</span></label>
                <textarea id="storeDesc" class="input" rows="3" placeholder="D√©cris ton activit√© en quelques mots..."></textarea>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Devise</label>
                  <select id="storeCurrency" class="input">
                    <option value="EUR">üá™üá∫ EUR (‚Ç¨)</option>
                    <option value="USD">üá∫üá∏ USD ($)</option>
                    <option value="GBP">üá¨üáß GBP (¬£)</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Couleur principale</label>
                  <div class="color-picker-row">
                    <input type="color" id="storeColor" value="#6C5CE7" class="color-picker-input">
                    <span class="color-picker-label" id="colorLabel">#6C5CE7</span>
                  </div>
                </div>
              </div>

              <div class="wizard-btn-row">
                <button type="button" class="btn btn-outline btn-lg" onclick="goToStep(1)">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                  Retour
                </button>
                <button type="button" class="btn btn-primary btn-lg wizard-next-btn" onclick="goToStep(3)">
                  Continuer
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                </button>
              </div>
            </div>

            <!-- STEP 3: LAUNCH -->
            <div class="wizard-panel" id="step3">
              <div class="wizard-panel-header">
                <span class="wizard-emoji">üöÄ</span>
                <h2>Pr√™t √† lancer !</h2>
                <p class="text-muted">V√©rifie le r√©cap et lance ta boutique.</p>
              </div>

              <div class="recap-card">
                <div class="recap-row">
                  <span class="recap-label">Nom</span>
                  <span class="recap-value" id="recapName">‚Äî</span>
                </div>
                <div class="recap-row">
                  <span class="recap-label">URL</span>
                  <span class="recap-value recap-url" id="recapUrl">‚Äî</span>
                </div>
                <div class="recap-row">
                  <span class="recap-label">Devise</span>
                  <span class="recap-value" id="recapCurrency">‚Äî</span>
                </div>
              </div>

              <div class="wizard-btn-row">
                <button type="button" class="btn btn-outline btn-lg" onclick="goToStep(2)">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                  Retour
                </button>
                <button type="button" class="btn btn-primary btn-lg wizard-next-btn" id="submitBtn" onclick="submitStore()">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                  Cr√©er ma boutique
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="/js/firebase-config.js"></script>
  <script src="/js/utils.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/api.js"></script>
  <script src="/js/db.js"></script>
  <script>
    // Mobile sidebar
    document.getElementById('sidebarToggle').addEventListener('click', () => {
      document.getElementById('sidebar').classList.toggle('open');
      document.getElementById('sidebarOverlay').classList.toggle('visible');
    });
    document.getElementById('sidebarOverlay').addEventListener('click', () => {
      document.getElementById('sidebar').classList.remove('open');
      document.getElementById('sidebarOverlay').classList.remove('visible');
    });

    let slugValid = false;
    let currentStep = 1;

    // Color picker preview
    document.getElementById('storeColor').addEventListener('input', (e) => {
      document.getElementById('colorLabel').textContent = e.target.value;
    });

    // ‚îÄ‚îÄ Wizard navigation ‚îÄ‚îÄ
    function goToStep(step) {
      if (step === 2 && !slugValid) return;

      // Update recap on step 3
      if (step === 3) {
        document.getElementById('recapName').textContent = document.getElementById('storeName').value.trim() || '‚Äî';
        document.getElementById('recapUrl').textContent = (document.getElementById('storeSlug').value.trim() || '‚Äî') + '.scalevo.shop';
        const currencyMap = { EUR: 'üá™üá∫ EUR (‚Ç¨)', USD: 'üá∫üá∏ USD ($)', GBP: 'üá¨üáß GBP (¬£)' };
        document.getElementById('recapCurrency').textContent = currencyMap[document.getElementById('storeCurrency').value] || 'EUR';
      }

      // Animate out current, animate in next
      document.querySelectorAll('.wizard-panel').forEach(p => p.classList.remove('active'));
      document.getElementById('step' + step).classList.add('active');

      // Update progress
      document.querySelectorAll('.wizard-step').forEach(s => {
        const n = parseInt(s.dataset.step);
        s.classList.toggle('active', n <= step);
        s.classList.toggle('completed', n < step);
      });
      document.querySelectorAll('.wizard-step-line').forEach((l, i) => {
        l.classList.toggle('active', (i + 1) < step);
      });

      currentStep = step;
    }

    // Auto-generate slug from name
    document.getElementById('storeName').addEventListener('input', (e) => {
      const slug = Utils.slugify(e.target.value);
      document.getElementById('storeSlug').value = slug;
      checkSlug(slug);
    });

    // Manual slug editing
    document.getElementById('storeSlug').addEventListener('input', (e) => {
      const slug = Utils.slugify(e.target.value);
      e.target.value = slug;
      checkSlug(slug);
    });

    const checkSlug = Utils.debounce(async (slug) => {
      const statusEl = document.getElementById('slugStatus');
      const btn = document.getElementById('toStep2');

      if (!slug || slug.length < 3) {
        statusEl.innerHTML = '<span class="slug-hint">Minimum 3 caract√®res</span>';
        slugValid = false;
        btn.disabled = true;
        return;
      }

      if (!Utils.isValidSlug(slug)) {
        statusEl.innerHTML = '<span class="slug-error">‚úó Ce nom est r√©serv√© ou invalide</span>';
        slugValid = false;
        btn.disabled = true;
        return;
      }

      statusEl.innerHTML = '<span class="slug-hint">V√©rification...</span>';
      const available = await DB.isSlugAvailable(slug);

      if (available) {
        statusEl.innerHTML = '<span class="slug-ok">‚úì ' + slug + '.scalevo.shop est disponible !</span>';
        slugValid = true;
        btn.disabled = false;
      } else {
        statusEl.innerHTML = '<span class="slug-error">‚úó D√©j√† pris ‚Äî essaie un autre nom</span>';
        slugValid = false;
        btn.disabled = true;
      }
    }, 400);

    // Submit
    async function submitStore() {
      if (!slugValid) return;

      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner" style="width:20px;height:20px;border-width:2px;"></div> Cr√©ation en cours...';

      try {
        const result = await API.createStore({
          name: document.getElementById('storeName').value.trim(),
          slug: document.getElementById('storeSlug').value.trim(),
          description: document.getElementById('storeDesc').value.trim(),
          currency: document.getElementById('storeCurrency').value,
          primaryColor: document.getElementById('storeColor').value
        });
        Utils.toast('Boutique cr√©√©e !', 'success');
        window.location.href = '/app/store.html?id=' + result.storeId;
      } catch (err) {
        Utils.toast('Erreur: ' + err.message, 'error');
        btn.disabled = false;
        btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg> Cr√©er ma boutique';
      }
    }

    Auth.init((user) => {
      if (!user) window.location.href = '/login.html';
    });
  </script>
</body>
</html>
