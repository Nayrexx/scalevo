<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nouvelle boutique ‚Äî Scalevo</title>
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/dashboard.css">
</head>
<body>
  <div class="dashboard-layout">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-logo"><span class="logo-icon">‚ö°</span> Scalevo</div>
      <nav class="sidebar-nav">
        <a href="/app/index.html" class="sidebar-link"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg> Dashboard</a>
        <a href="/app/stores.html" class="sidebar-link active"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg> Mes boutiques</a>
        <a href="/app/features.html" class="sidebar-link"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg> Modules</a>
        <a href="/app/account.html" class="sidebar-link"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> Mon compte</a>
      </nav>
      <div class="sidebar-footer">
        <button class="sidebar-link" onclick="Auth.signOut()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg> D√©connexion</button>
      </div>
    </aside>

    <main class="dashboard-main">
      <header class="topbar">
        <button class="mobile-sidebar-toggle" id="sidebarToggle"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
        <h1 class="topbar-title">Nouvelle boutique</h1>
        <div class="topbar-right">
          <a href="/app/stores.html" class="btn btn-outline btn-sm">‚Üê Retour</a>
        </div>
      </header>

      <div class="dashboard-content">
        <div class="wizard">
          <div class="wizard-container">
            <!-- PROGRESS BAR -->
            <div class="wizard-progress">
              <div class="wizard-step active" data-step="1">
                <div class="wizard-step-circle">1</div>
                <span>Identit√©</span>
              </div>
              <div class="wizard-step-line"></div>
              <div class="wizard-step" data-step="2">
                <div class="wizard-step-circle">2</div>
                <span>Design</span>
              </div>
              <div class="wizard-step-line"></div>
              <div class="wizard-step" data-step="3">
                <div class="wizard-step-circle">3</div>
                <span>Paiement</span>
              </div>
              <div class="wizard-step-line"></div>
              <div class="wizard-step" data-step="4">
                <div class="wizard-step-circle">4</div>
                <span>Lancement</span>
              </div>
            </div>

            <!-- STEP 1: IDENTITY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div class="wizard-panel active" id="step1">
              <div class="wizard-panel-header">
                <span class="wizard-emoji">üè™</span>
                <h2>Donne un nom √† ta boutique</h2>
                <p class="text-muted">C'est ce que tes clients verront. Tu pourras le changer apr√®s.</p>
              </div>

              <div class="form-group" style="margin-bottom:1.5rem;">
                <label class="form-label">Nom de la boutique</label>
                <input type="text" id="storeName" class="input input-lg" placeholder="Ex: FitGear, LumiDeco, SnapCase..." required autofocus>
              </div>

              <div class="form-group" style="margin-bottom:1.5rem;">
                <label class="form-label">Adresse de ta boutique</label>
                <div class="slug-input-wrapper">
                  <input type="text" id="storeSlug" class="input input-lg" placeholder="ma-boutique" required>
                  <span class="slug-suffix">.scalevo.shop</span>
                </div>
                <div id="slugStatus" class="slug-status"></div>
              </div>

              <button type="button" class="btn btn-primary btn-lg wizard-next-btn" id="toStep2" disabled onclick="goToStep(2)">
                Continuer
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
              </button>
            </div>

            <!-- STEP 2: DESIGN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div class="wizard-panel" id="step2">
              <div class="wizard-panel-header">
                <span class="wizard-emoji">üé®</span>
                <h2>Personnalise le look</h2>
                <p class="text-muted">Choisis la couleur et ajoute une description.</p>
              </div>

              <div class="form-group" style="margin-bottom:1.5rem;">
                <label class="form-label">Description <span class="text-muted">(optionnel)</span></label>
                <textarea id="storeDesc" class="input" rows="3" placeholder="D√©cris ton activit√© en quelques mots..."></textarea>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Devise</label>
                  <select id="storeCurrency" class="input">
                    <option value="EUR">üá™üá∫ EUR (‚Ç¨)</option>
                    <option value="USD">üá∫üá∏ USD ($)</option>
                    <option value="GBP">üá¨üáß GBP (¬£)</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Couleur principale</label>
                  <div class="color-picker-row">
                    <input type="color" id="storeColor" value="#6C5CE7" class="color-picker-input">
                    <span class="color-picker-label" id="colorLabel">#6C5CE7</span>
                  </div>
                </div>
              </div>

              <!-- Live preview -->
              <div class="wizard-preview" id="livePreview">
                <div class="wizard-preview-label">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                  Aper√ßu
                </div>
                <div class="wizard-preview-card" id="previewCard">
                  <div class="wizard-preview-icon" id="previewIcon" style="background:#6C5CE7;">B</div>
                  <div class="wizard-preview-text">
                    <strong id="previewName">Ma boutique</strong>
                    <span id="previewUrl">ma-boutique.scalevo.shop</span>
                  </div>
                  <span class="badge badge-outline" style="font-size:0.6875rem;">Brouillon</span>
                </div>
              </div>

              <div class="wizard-btn-row">
                <button type="button" class="btn btn-outline btn-lg" onclick="goToStep(1)">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                  Retour
                </button>
                <button type="button" class="btn btn-primary btn-lg wizard-next-btn" onclick="goToStep(3)">
                  Continuer
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                </button>
              </div>
            </div>

            <!-- STEP 3: STRIPE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div class="wizard-panel" id="step3">
              <div class="wizard-panel-header">
                <span class="wizard-emoji">üí≥</span>
                <h2>Connecte Stripe</h2>
                <p class="text-muted">Pour recevoir les paiements de tes clients. Tu peux aussi le faire plus tard.</p>
              </div>

              <div class="wizard-stripe-info">
                <div class="wizard-stripe-icon">
                  <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--brand)" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                </div>
                <div>
                  <strong>Pourquoi Stripe ?</strong>
                  <p class="text-muted text-sm" style="margin:4px 0 0;">Stripe est le leader mondial du paiement en ligne. Tes clients paient en toute s√©curit√©, tu re√ßois l'argent directement sur ton compte bancaire.</p>
                </div>
              </div>

              <div class="form-group" style="margin-bottom:1.25rem;">
                <label class="form-label">Cl√© publique <code style="font-size:0.75rem;">pk_live_...</code></label>
                <input type="text" id="stripePK" class="input" placeholder="pk_live_xxx ou pk_test_xxx">
              </div>

              <div class="form-group" style="margin-bottom:1.25rem;">
                <label class="form-label">Cl√© secr√®te <code style="font-size:0.75rem;">sk_live_...</code></label>
                <input type="password" id="stripeSK" class="input" placeholder="sk_live_xxx ou sk_test_xxx">
                <small class="text-muted">Stock√©e de mani√®re s√©curis√©e, jamais expos√©e c√¥t√© client.</small>
              </div>

              <div class="stripe-info-box" style="margin-bottom:1.5rem;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--brand)" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                <span>Trouve tes cl√©s sur <a href="https://dashboard.stripe.com/apikeys" target="_blank" style="color:var(--brand);text-decoration:underline;">dashboard.stripe.com/apikeys</a></span>
              </div>

              <div class="wizard-skip-row">
                <button type="button" class="btn btn-ghost" onclick="goToStep(4)">Passer cette √©tape ‚Üí</button>
              </div>

              <div class="wizard-btn-row">
                <button type="button" class="btn btn-outline btn-lg" onclick="goToStep(2)">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                  Retour
                </button>
                <button type="button" class="btn btn-primary btn-lg wizard-next-btn" onclick="goToStep(4)">
                  Continuer
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                </button>
              </div>
            </div>

            <!-- STEP 4: LAUNCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div class="wizard-panel" id="step4">
              <div class="wizard-panel-header">
                <span class="wizard-emoji">üöÄ</span>
                <h2>Pr√™t √† lancer !</h2>
                <p class="text-muted">V√©rifie le r√©cap et lance ta boutique.</p>
              </div>

              <div class="recap-card">
                <div class="recap-row">
                  <span class="recap-label">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/></svg>
                    Nom
                  </span>
                  <span class="recap-value" id="recapName">‚Äî</span>
                </div>
                <div class="recap-row">
                  <span class="recap-label">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>
                    URL
                  </span>
                  <span class="recap-value recap-url" id="recapUrl">‚Äî</span>
                </div>
                <div class="recap-row">
                  <span class="recap-label">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                    Devise
                  </span>
                  <span class="recap-value" id="recapCurrency">‚Äî</span>
                </div>
                <div class="recap-row">
                  <span class="recap-label">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                    Stripe
                  </span>
                  <span class="recap-value" id="recapStripe">‚Äî</span>
                </div>
                <div class="recap-row">
                  <span class="recap-label">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 3v3M12 18v3M4.22 4.22l2.12 2.12M17.66 17.66l2.12 2.12M3 12h3M18 12h3M4.22 19.78l2.12-2.12M17.66 6.34l2.12-2.12"/></svg>
                    Couleur
                  </span>
                  <span class="recap-value" id="recapColor">
                    <span class="recap-color-dot" id="recapColorDot"></span>
                    <span id="recapColorHex">#6C5CE7</span>
                  </span>
                </div>
              </div>

              <!-- Next steps preview -->
              <div class="wizard-next-steps">
                <h4>Prochaines √©tapes apr√®s la cr√©ation :</h4>
                <div class="wizard-next-step">
                  <span class="wizard-next-step-num">1</span>
                  <div>
                    <strong>Ajouter ton produit</strong>
                    <p>Nom, prix, images et description</p>
                  </div>
                </div>
                <div class="wizard-next-step">
                  <span class="wizard-next-step-num">2</span>
                  <div>
                    <strong>Configurer ton funnel</strong>
                    <p>Bundles, order bump, upsell post-achat</p>
                  </div>
                </div>
                <div class="wizard-next-step">
                  <span class="wizard-next-step-num">3</span>
                  <div>
                    <strong>Publier ta boutique</strong>
                    <p>Un clic et tu es en ligne !</p>
                  </div>
                </div>
              </div>

              <div class="wizard-btn-row">
                <button type="button" class="btn btn-outline btn-lg" onclick="goToStep(3)">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                  Retour
                </button>
                <button type="button" class="btn btn-primary btn-lg wizard-next-btn" id="submitBtn" onclick="submitStore()">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                  Cr√©er ma boutique
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="/js/firebase-config.js"></script>
  <script src="/js/utils.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/api.js"></script>
  <script src="/js/db.js"></script>
  <script>
    // Mobile sidebar
    document.getElementById('sidebarToggle').addEventListener('click', () => {
      document.getElementById('sidebar').classList.toggle('open');
      document.getElementById('sidebarOverlay').classList.toggle('visible');
    });
    document.getElementById('sidebarOverlay').addEventListener('click', () => {
      document.getElementById('sidebar').classList.remove('open');
      document.getElementById('sidebarOverlay').classList.remove('visible');
    });

    let slugValid = false;
    let currentStep = 1;

    // Color picker preview
    document.getElementById('storeColor').addEventListener('input', (e) => {
      document.getElementById('colorLabel').textContent = e.target.value;
      document.getElementById('previewIcon').style.background = e.target.value;
    });

    // ‚îÄ‚îÄ Live preview update ‚îÄ‚îÄ
    function updatePreview() {
      const name = document.getElementById('storeName').value.trim() || 'Ma boutique';
      const slug = document.getElementById('storeSlug').value.trim() || 'ma-boutique';
      const color = document.getElementById('storeColor').value;
      document.getElementById('previewName').textContent = name;
      document.getElementById('previewUrl').textContent = slug + '.scalevo.shop';
      document.getElementById('previewIcon').textContent = name.charAt(0).toUpperCase();
      document.getElementById('previewIcon').style.background = color;
    }

    // ‚îÄ‚îÄ Wizard navigation ‚îÄ‚îÄ
    function goToStep(step) {
      if (step === 2 && !slugValid) return;

      // Update preview
      if (step === 2) updatePreview();

      // Update recap on step 4
      if (step === 4) {
        document.getElementById('recapName').textContent = document.getElementById('storeName').value.trim() || '‚Äî';
        document.getElementById('recapUrl').textContent = (document.getElementById('storeSlug').value.trim() || '‚Äî') + '.scalevo.shop';
        const currencyMap = { EUR: 'üá™üá∫ EUR (‚Ç¨)', USD: 'üá∫üá∏ USD ($)', GBP: 'üá¨üáß GBP (¬£)' };
        document.getElementById('recapCurrency').textContent = currencyMap[document.getElementById('storeCurrency').value] || 'EUR';

        const stripePK = document.getElementById('stripePK').value.trim();
        if (stripePK) {
          document.getElementById('recapStripe').innerHTML = '<span style="color:var(--success);">‚úì Connect√©</span>';
        } else {
          document.getElementById('recapStripe').innerHTML = '<span style="color:var(--warning, #f59e0b);">‚ö† Non configur√©</span>';
        }

        const color = document.getElementById('storeColor').value;
        document.getElementById('recapColorDot').style.background = color;
        document.getElementById('recapColorHex').textContent = color;
      }

      // Animate out current, animate in next
      document.querySelectorAll('.wizard-panel').forEach(p => p.classList.remove('active'));
      document.getElementById('step' + step).classList.add('active');

      // Update progress
      document.querySelectorAll('.wizard-step').forEach(s => {
        const n = parseInt(s.dataset.step);
        s.classList.toggle('active', n <= step);
        s.classList.toggle('completed', n < step);
      });
      document.querySelectorAll('.wizard-step-line').forEach((l, i) => {
        l.classList.toggle('active', (i + 1) < step);
      });

      currentStep = step;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Auto-generate slug from name
    document.getElementById('storeName').addEventListener('input', (e) => {
      const slug = Utils.slugify(e.target.value);
      document.getElementById('storeSlug').value = slug;
      checkSlug(slug);
    });

    // Manual slug editing
    document.getElementById('storeSlug').addEventListener('input', (e) => {
      const slug = Utils.slugify(e.target.value);
      e.target.value = slug;
      checkSlug(slug);
    });

    const checkSlug = Utils.debounce(async (slug) => {
      const statusEl = document.getElementById('slugStatus');
      const btn = document.getElementById('toStep2');

      if (!slug || slug.length < 3) {
        statusEl.innerHTML = '<span class="slug-hint">Minimum 3 caract√®res</span>';
        slugValid = false;
        btn.disabled = true;
        return;
      }

      if (!Utils.isValidSlug(slug)) {
        statusEl.innerHTML = '<span class="slug-error">‚úó Ce nom est r√©serv√© ou invalide</span>';
        slugValid = false;
        btn.disabled = true;
        return;
      }

      statusEl.innerHTML = '<span class="slug-hint">V√©rification...</span>';
      const available = await DB.isSlugAvailable(slug);

      if (available) {
        statusEl.innerHTML = '<span class="slug-ok">‚úì ' + slug + '.scalevo.shop est disponible !</span>';
        slugValid = true;
        btn.disabled = false;
      } else {
        statusEl.innerHTML = '<span class="slug-error">‚úó D√©j√† pris ‚Äî essaie un autre nom</span>';
        slugValid = false;
        btn.disabled = true;
      }
    }, 400);

    // Submit
    async function submitStore() {
      if (!slugValid) return;

      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner" style="width:20px;height:20px;border-width:2px;"></div> Cr√©ation en cours...';

      try {
        const result = await API.createStore({
          name: document.getElementById('storeName').value.trim(),
          slug: document.getElementById('storeSlug').value.trim(),
          description: document.getElementById('storeDesc').value.trim(),
          currency: document.getElementById('storeCurrency').value,
          primaryColor: document.getElementById('storeColor').value,
          stripePublishableKey: document.getElementById('stripePK').value.trim(),
          stripeSecretKey: document.getElementById('stripeSK').value.trim()
        });
        Utils.toast('Boutique cr√©√©e ! üéâ', 'success');
        window.location.href = '/app/store.html?id=' + result.storeId + '&new=1';
      } catch (err) {
        Utils.toast('Erreur: ' + err.message, 'error');
        btn.disabled = false;
        btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg> Cr√©er ma boutique';
      }
    }

    Auth.init((user) => {
      if (!user) window.location.href = '/login.html';
    });
  </script>
</body>
</html>
