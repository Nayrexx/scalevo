<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="pageTitle">Boutique</title>
  <meta name="description" id="pageMeta" content="">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/storefront.css">
</head>
<body class="storefront">

  <!-- PREVIEW BANNER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="sf-preview-banner" id="previewBanner" style="display:none;">
    <div class="sf-preview-banner-inner">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
      <span>MODE PREVIEW ‚Äî Cette boutique n'est pas encore publi√©e</span>
      <a id="previewBackLink" href="#" class="sf-preview-back">‚Üê Retour au dashboard</a>
    </div>
  </div>

  <!-- ANNOUNCEMENT BAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="sf-announcement" id="countdownBar" style="display:none;">
    <div class="sf-announcement-inner">
      <span class="sf-announcement-pulse"></span>
      <span>üî• Offre limit√©e ‚Äî expire dans <strong id="countdownTimer">15:00</strong></span>
    </div>
  </div>

  <!-- HEADER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <header class="sf-header" id="sfHeader" style="display:none;">
    <div class="sf-header-inner">
      <a class="sf-brand" href="#">
        <span class="sf-brand-icon" id="brandIcon">üè™</span>
        <span class="sf-brand-name" id="brandName">Boutique</span>
      </a>
      <div class="sf-header-trust">
        <span class="sf-header-badge">üîí Paiement s√©curis√©</span>
        <span class="sf-header-badge sf-hide-mobile">üöö Livraison offerte</span>
      </div>
    </div>
  </header>

  <!-- LOADING STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="sf-loader" id="loader">
    <div class="sf-loader-spinner"></div>
    <p>Chargement de la boutique...</p>
  </div>

  <!-- 404 STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="sf-empty" id="notFound" style="display:none;">
    <div class="sf-empty-icon">üîç</div>
    <h1>Boutique introuvable</h1>
    <p>Cette boutique n'existe pas ou n'est plus disponible.</p>
    <a href="https://scalevo.shop" class="sf-btn sf-btn-primary">Retour √† Scalevo</a>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       MAIN PRODUCT PAGE
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="productPage" style="display:none;">

    <!-- HERO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <section class="sf-hero">
      <div class="sf-container sf-hero-layout">
        <!-- Gallery -->
        <div class="sf-gallery">
          <div class="sf-gallery-main" id="galleryMain">
            <img id="mainImage" src="" alt="" class="sf-gallery-img">
            <span class="sf-gallery-badge" id="discountBadge" style="display:none;"></span>
            <button class="sf-gallery-nav sf-gallery-prev" id="galleryPrev" style="display:none;" onclick="galleryNav(-1)">‚Äπ</button>
            <button class="sf-gallery-nav sf-gallery-next" id="galleryNext" style="display:none;" onclick="galleryNav(1)">‚Ä∫</button>
          </div>
          <div class="sf-gallery-thumbs" id="thumbs"></div>
        </div>

        <!-- Product Info -->
        <div class="sf-info">
          <div class="sf-info-scroll">
            <!-- Rating -->
            <div class="sf-rating" id="ratingSection">
              <div class="sf-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
              <span class="sf-rating-count">(127 avis)</span>
            </div>

            <h1 class="sf-product-name" id="productName"></h1>

            <div class="sf-price-block">
              <span class="sf-price" id="priceDisplay"></span>
              <span class="sf-price-old" id="comparePriceDisplay"></span>
              <span class="sf-price-save" id="saveDisplay" style="display:none;"></span>
            </div>

            <!-- Short desc -->
            <p class="sf-short-desc" id="shortDesc" style="display:none;"></p>

            <!-- Features -->
            <div class="sf-features" id="featuresDisplay"></div>

            <!-- Bundles -->
            <div class="sf-bundles" id="bundlesSection" style="display:none;">
              <p class="sf-bundles-label">Choisissez votre offre :</p>
              <div id="bundlesList"></div>
            </div>

            <!-- Order Bump -->
            <div class="sf-bump" id="bumpSection" style="display:none;">
              <label class="sf-bump-label">
                <input type="checkbox" id="bumpCheckbox">
                <span class="sf-bump-check">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
                </span>
                <div class="sf-bump-text">
                  <strong id="bumpTitle"></strong>
                  <span id="bumpDesc"></span>
                </div>
                <span class="sf-bump-price" id="bumpPriceDisplay"></span>
              </label>
            </div>

            <!-- Promo Code Input -->
            <div class="sf-promo" id="promoSection">
              <div class="sf-promo-input-row">
                <input type="text" id="promoInput" class="sf-promo-input" placeholder="Code promo" style="text-transform:uppercase;">
                <button type="button" class="sf-promo-btn" id="promoApplyBtn" onclick="applyPromoCode()">Appliquer</button>
              </div>
              <div class="sf-promo-msg" id="promoMsg" style="display:none;"></div>
            </div>

            <!-- Stock badge -->
            <div class="sf-stock-badge" id="stockBadge" style="display:none;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
              <span id="stockText"></span>
            </div>

            <!-- CTA -->
            <button class="sf-cta" id="ctaBtn" onclick="startCheckout()">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 002-1.61L23 6H6"/></svg>
              Commander maintenant ‚Äî <span id="ctaPrice"></span>
            </button>

            <!-- Trust row -->
            <div class="sf-trust-row">
              <div class="sf-trust-item">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
                <span>Paiement<br>s√©curis√©</span>
              </div>
              <div class="sf-trust-item">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
                <span>Livraison<br>offerte</span>
              </div>
              <div class="sf-trust-item">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                <span>Garantie<br>30 jours</span>
              </div>
              <div class="sf-trust-item">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                <span>Stock<br>limit√©</span>
              </div>
            </div>

            <!-- Payment icons -->
            <div class="sf-payment-icons">
              <span class="sf-pay-label">Moyens de paiement accept√©s</span>
              <div class="sf-pay-row">
                <div class="sf-pay-icon">üí≥ Visa</div>
                <div class="sf-pay-icon">üí≥ Mastercard</div>
                <div class="sf-pay-icon">üí≥ CB</div>
                <div class="sf-pay-icon">üçé Apple Pay</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- SOCIAL PROOF BAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <section class="sf-social-bar">
      <div class="sf-container">
        <div class="sf-social-bar-inner">
          <div class="sf-social-stat">
            <strong>1 247</strong>
            <span>commandes</span>
          </div>
          <div class="sf-social-divider"></div>
          <div class="sf-social-stat">
            <strong>4.8/5</strong>
            <span>note moyenne</span>
          </div>
          <div class="sf-social-divider"></div>
          <div class="sf-social-stat">
            <strong>98%</strong>
            <span>satisfaction</span>
          </div>
        </div>
      </div>
    </section>

    <!-- DESCRIPTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <section class="sf-section" id="descriptionSection" style="display:none;">
      <div class="sf-container sf-section-narrow">
        <h2 class="sf-section-title">√Ä propos du produit</h2>
        <div id="descriptionContent" class="sf-description-text"></div>
      </div>
    </section>

    <!-- WHY US ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <section class="sf-section sf-section-alt">
      <div class="sf-container">
        <h2 class="sf-section-title">Pourquoi nous choisir</h2>
        <div class="sf-advantages-grid">
          <div class="sf-advantage">
            <div class="sf-advantage-icon">üöö</div>
            <h3>Livraison gratuite</h3>
            <p>Exp√©dition sous 24h et livraison en 7-14 jours dans toute la France.</p>
          </div>
          <div class="sf-advantage">
            <div class="sf-advantage-icon">üõ°Ô∏è</div>
            <h3>Garantie 30 jours</h3>
            <p>Remboursement int√©gral sans condition si tu n'es pas satisfait.</p>
          </div>
          <div class="sf-advantage">
            <div class="sf-advantage-icon">üîí</div>
            <h3>Paiement s√©curis√©</h3>
            <p>Transactions crypt√©es SSL via Stripe, leader mondial du paiement.</p>
          </div>
          <div class="sf-advantage">
            <div class="sf-advantage-icon">üìû</div>
            <h3>Support r√©actif</h3>
            <p>Une question ? Notre √©quipe te r√©pond en moins de 24h par email.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- REVIEWS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <section class="sf-section">
      <div class="sf-container">
        <h2 class="sf-section-title">Ce que disent nos clients</h2>
        <div class="sf-reviews-grid">
          <div class="sf-review-card">
            <div class="sf-review-head">
              <div class="sf-review-avatar">M</div>
              <div>
                <strong>Marie P.</strong>
                <div class="sf-review-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
              </div>
              <span class="sf-review-verified">‚úì Achat v√©rifi√©</span>
            </div>
            <p>"Produit de super qualit√©, livraison rapide. Je recommande √† 100% !"</p>
          </div>
          <div class="sf-review-card">
            <div class="sf-review-head">
              <div class="sf-review-avatar">T</div>
              <div>
                <strong>Thomas R.</strong>
                <div class="sf-review-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
              </div>
              <span class="sf-review-verified">‚úì Achat v√©rifi√©</span>
            </div>
            <p>"Conforme √† la description, tr√®s bon rapport qualit√©/prix. Je recommande."</p>
          </div>
          <div class="sf-review-card">
            <div class="sf-review-head">
              <div class="sf-review-avatar">S</div>
              <div>
                <strong>Sophie M.</strong>
                <div class="sf-review-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
              </div>
              <span class="sf-review-verified">‚úì Achat v√©rifi√©</span>
            </div>
            <p>"J'en ai command√© 2 de plus tellement j'√©tais contente. Merci !"</p>
          </div>
          <div class="sf-review-card">
            <div class="sf-review-head">
              <div class="sf-review-avatar">L</div>
              <div>
                <strong>Lucas D.</strong>
                <div class="sf-review-stars">‚òÖ‚òÖ‚òÖ‚òÖ<span style="opacity:0.3">‚òÖ</span></div>
              </div>
              <span class="sf-review-verified">‚úì Achat v√©rifi√©</span>
            </div>
            <p>"Beau produit, bien emball√©. Petit d√©lai de livraison mais rien de grave."</p>
          </div>
        </div>
      </div>
    </section>

    <!-- FAQ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <section class="sf-section sf-section-alt" id="faqSection">
      <div class="sf-container sf-section-narrow">
        <h2 class="sf-section-title">Questions fr√©quentes</h2>
        <div class="sf-faq-list">
          <div class="sf-faq-item">
            <button class="sf-faq-q" onclick="toggleFaq(this)">
              <span>Quels sont les d√©lais de livraison ?</span>
              <svg class="sf-faq-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
            </button>
            <div class="sf-faq-a"><p>La livraison prend entre 7 et 14 jours ouvr√©s. Vous recevrez un email avec le num√©ro de suivi d√®s l'exp√©dition.</p></div>
          </div>
          <div class="sf-faq-item">
            <button class="sf-faq-q" onclick="toggleFaq(this)">
              <span>Comment fonctionne le remboursement ?</span>
              <svg class="sf-faq-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
            </button>
            <div class="sf-faq-a"><p>Contactez-nous dans les 30 jours suivant la r√©ception. Nous vous remboursons int√©gralement sans questions ni conditions.</p></div>
          </div>
          <div class="sf-faq-item">
            <button class="sf-faq-q" onclick="toggleFaq(this)">
              <span>Le paiement est-il s√©curis√© ?</span>
              <svg class="sf-faq-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
            </button>
            <div class="sf-faq-a"><p>Oui, tous les paiements sont trait√©s par Stripe, le leader mondial du paiement en ligne. Vos donn√©es bancaires sont 100% s√©curis√©es et crypt√©es.</p></div>
          </div>
          <div class="sf-faq-item">
            <button class="sf-faq-q" onclick="toggleFaq(this)">
              <span>Puis-je suivre ma commande ?</span>
              <svg class="sf-faq-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
            </button>
            <div class="sf-faq-a"><p>Oui, un num√©ro de tracking vous sera envoy√© par email d√®s que votre commande sera exp√©di√©e. Vous pourrez suivre votre colis en temps r√©el.</p></div>
          </div>
        </div>
      </div>
    </section>

    <!-- FINAL CTA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <section class="sf-final-cta">
      <div class="sf-container" style="text-align:center;">
        <h2>Ne ratez pas cette offre</h2>
        <p>Commandez maintenant et recevez votre produit rapidement.</p>
        <button class="sf-cta" style="max-width:420px; margin:0 auto;" onclick="window.scrollTo({top:0,behavior:'smooth'})">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 002-1.61L23 6H6"/></svg>
          Je commande maintenant
        </button>
      </div>
    </section>

    <!-- FOOTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <footer class="sf-footer">
      <div class="sf-container">
        <div class="sf-footer-inner">
          <div class="sf-footer-brand">
            <span class="sf-brand-icon" id="footerBrandIcon">üè™</span>
            <span class="sf-brand-name" id="footerBrandName">Boutique</span>
          </div>
          <div class="sf-footer-links">
            <a href="#" onclick="document.getElementById('faqSection').scrollIntoView({behavior:'smooth'});return false;">FAQ</a>
            <a href="mailto:contact@scalevo.shop">Contact</a>
          </div>
          <div class="sf-footer-copy">
            ¬© <span id="footerYear">2026</span> <span id="footerCopy">Boutique</span> ‚Äî Propuls√© par <a href="https://scalevo.shop" target="_blank" rel="noopener">Scalevo</a>
          </div>
        </div>
      </div>
    </footer>

    <!-- STICKY MOBILE CTA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="sf-sticky-cta" id="stickyCta">
      <button class="sf-cta sf-cta-sticky" onclick="startCheckout()">
        üõí Commander ‚Äî <span id="stickyPrice"></span>
      </button>
    </div>
  </div>

  <!-- Firebase + Scripts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <script src="/js/firebase-config.js"></script>
  <script src="/js/utils.js"></script>
  <script src="/js/db.js"></script>
  <script src="/js/store-resolver.js"></script>
  <script>
    let storeData = null;
    let productData = null;
    let funnelData = null;
    let selectedBundle = null;
    let bumpSelected = false;
    let currentImgIndex = 0;
    let allImages = [];
    let appliedPromo = null;
    let isPreviewMode = false;

    function toggleFaq(btn) {
      const item = btn.parentElement;
      const isOpen = item.classList.contains('open');
      document.querySelectorAll('.sf-faq-item').forEach(i => i.classList.remove('open'));
      if (!isOpen) item.classList.add('open');
    }

    function galleryNav(dir) {
      currentImgIndex += dir;
      if (currentImgIndex < 0) currentImgIndex = allImages.length - 1;
      if (currentImgIndex >= allImages.length) currentImgIndex = 0;
      setGalleryImage(currentImgIndex);
    }

    function setGalleryImage(index) {
      currentImgIndex = index;
      document.getElementById('mainImage').src = allImages[index];
      document.querySelectorAll('.sf-thumb').forEach((t, i) => t.classList.toggle('active', i === index));
    }

    function selectBundle(index) {
      document.querySelectorAll('.sf-bundle-option').forEach((el, i) => el.classList.toggle('selected', i === index));
      selectedBundle = funnelData.bundles[index];
      updatePrice();
    }

    function updatePrice() {
      let basePrice = productData.price;
      if (selectedBundle) basePrice = selectedBundle.unitPrice * selectedBundle.qty;
      let total = basePrice;
      if (bumpSelected && funnelData?.orderBump?.price) total += funnelData.orderBump.price;

      // Apply promo discount
      if (appliedPromo) {
        if (appliedPromo.type === 'percent') {
          total = total * (1 - appliedPromo.value / 100);
        } else {
          total = Math.max(0, total - appliedPromo.value);
        }
      }

      const label = Utils.formatPrice(total);
      document.getElementById('priceDisplay').textContent = label;
      document.getElementById('stickyPrice').textContent = label;
      document.getElementById('ctaPrice').textContent = label;
    }

    async function applyPromoCode() {
      const code = document.getElementById('promoInput').value.trim().toUpperCase();
      const msgEl = document.getElementById('promoMsg');
      if (!code) return;

      try {
        // Check promo codes from Firestore
        const snap = await db.collection('stores').doc(storeData.id)
          .collection('promoCodes')
          .where('code', '==', code)
          .where('active', '==', true)
          .limit(1)
          .get();

        if (snap.empty) {
          msgEl.textContent = '‚ùå Code invalide ou expir√©';
          msgEl.className = 'sf-promo-msg sf-promo-error';
          msgEl.style.display = '';
          appliedPromo = null;
          updatePrice();
          return;
        }

        const promo = snap.docs[0].data();

        // Check expiry
        if (promo.expiresAt && new Date(promo.expiresAt) < new Date()) {
          msgEl.textContent = '‚ùå Ce code a expir√©';
          msgEl.className = 'sf-promo-msg sf-promo-error';
          msgEl.style.display = '';
          appliedPromo = null;
          updatePrice();
          return;
        }

        // Check max usage
        if (promo.maxUse && promo.usageCount >= promo.maxUse) {
          msgEl.textContent = '‚ùå Ce code a atteint son nombre max d\'utilisations';
          msgEl.className = 'sf-promo-msg sf-promo-error';
          msgEl.style.display = '';
          appliedPromo = null;
          updatePrice();
          return;
        }

        appliedPromo = { ...promo, id: snap.docs[0].id };
        const desc = promo.type === 'percent' ? `-${promo.value}%` : `-${Utils.formatPrice(promo.value)}`;
        msgEl.textContent = `‚úÖ Code appliqu√© : ${desc}`;
        msgEl.className = 'sf-promo-msg sf-promo-success';
        msgEl.style.display = '';
        document.getElementById('promoApplyBtn').textContent = '‚úì';
        updatePrice();
      } catch(e) {
        msgEl.textContent = '‚ùå Erreur lors de la v√©rification';
        msgEl.className = 'sf-promo-msg sf-promo-error';
        msgEl.style.display = '';
      }
    }

    async function startCheckout() {
      // Block checkout in preview mode
      if (isPreviewMode) {
        alert('Mode pr√©visualisation ‚Äî le paiement est d√©sactiv√©.');
        return;
      }

      // Check stock before checkout
      if (productData.stock != null && productData.stock <= 0) {
        alert('Ce produit est en rupture de stock.');
        return;
      }

      const btn = document.getElementById('ctaBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="sf-cta-spinner"></span> Redirection...';
      try {
        const body = {
          storeId: storeData.id,
          productId: productData.id,
          bundleIndex: selectedBundle ? funnelData.bundles.indexOf(selectedBundle) : null,
          includeOrderBump: bumpSelected,
          promoCode: appliedPromo ? appliedPromo.code : null,
          successUrl: window.location.origin + '/success.html?store=' + storeData.id,
          cancelUrl: window.location.href
        };
        const res = await fetch('/.netlify/functions/createStoreCheckoutSession', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Erreur checkout');
        const stripe = getStripeForStore(storeData.stripePublishableKey);
        await stripe.redirectToCheckout({ sessionId: data.sessionId });
      } catch(e) {
        alert('Erreur: ' + e.message);
        btn.disabled = false;
        btn.innerHTML = 'üõí Commander maintenant';
      }
    }

    function startCountdown(minutes) {
      document.getElementById('countdownBar').style.display = '';
      let seconds = minutes * 60;
      const timerEl = document.getElementById('countdownTimer');
      setInterval(() => {
        seconds--;
        if (seconds <= 0) return;
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        timerEl.textContent = m.toString().padStart(2, '0') + ':' + s.toString().padStart(2, '0');
      }, 1000);
    }

    async function init() {
      const slug = StoreResolver.getSlug();
      const params = new URLSearchParams(window.location.search);
      const urlSlug = slug || params.get('slug');
      const previewToken = params.get('preview');

      if (!urlSlug) {
        document.getElementById('loader').style.display = 'none';
        document.getElementById('notFound').style.display = '';
        return;
      }

      const storeId = await StoreResolver.resolve(urlSlug);
      if (!storeId) {
        document.getElementById('loader').style.display = 'none';
        document.getElementById('notFound').style.display = '';
        return;
      }

      storeData = await StoreResolver.loadStore(storeId);

      // Preview mode: allow viewing unpublished stores if token matches storeId
      if (previewToken && previewToken === storeId) {
        isPreviewMode = true;
      }

      if (!storeData || (!storeData.published && !isPreviewMode)) {
        document.getElementById('loader').style.display = 'none';
        document.getElementById('notFound').style.display = '';
        return;
      }

      // Show preview banner if in preview mode
      if (isPreviewMode && !storeData.published) {
        document.getElementById('previewBanner').style.display = '';
        document.getElementById('previewBackLink').href = '/app/store.html?id=' + storeId;
      }

      productData = await StoreResolver.loadProduct(storeId, isPreviewMode);
      if (!productData) {
        document.getElementById('loader').style.display = 'none';
        document.getElementById('notFound').style.display = '';
        return;
      }

      funnelData = await StoreResolver.loadFunnel(storeId);

      // Theme color
      if (storeData.primaryColor) {
        document.documentElement.style.setProperty('--sf-primary', storeData.primaryColor);
      }

      // Theme class
      if (storeData.theme && storeData.theme !== 'classic') {
        document.body.classList.add('sf-theme-' + storeData.theme);
      }

      // Header
      document.getElementById('sfHeader').style.display = '';
      const initial = (storeData.name || 'B').charAt(0).toUpperCase();
      document.getElementById('brandIcon').textContent = initial;
      document.getElementById('brandIcon').style.background = storeData.primaryColor || 'var(--sf-primary)';
      document.getElementById('brandName').textContent = storeData.name;
      document.getElementById('footerBrandIcon').textContent = initial;
      document.getElementById('footerBrandIcon').style.background = storeData.primaryColor || 'var(--sf-primary)';
      document.getElementById('footerBrandName').textContent = storeData.name;
      document.getElementById('footerCopy').textContent = storeData.name;

      // Title
      document.getElementById('pageTitle').textContent = productData.name + ' ‚Äî ' + storeData.name;
      document.getElementById('pageMeta').content = productData.description || '';
      document.getElementById('productName').textContent = productData.name;

      // Price
      document.getElementById('priceDisplay').textContent = Utils.formatPrice(productData.price);
      document.getElementById('stickyPrice').textContent = Utils.formatPrice(productData.price);
      document.getElementById('ctaPrice').textContent = Utils.formatPrice(productData.price);
      if (productData.comparePrice && productData.comparePrice > productData.price) {
        document.getElementById('comparePriceDisplay').textContent = Utils.formatPrice(productData.comparePrice);
        const discount = Math.round((1 - productData.price / productData.comparePrice) * 100);
        document.getElementById('discountBadge').textContent = '-' + discount + '%';
        document.getElementById('discountBadge').style.display = '';
        const saved = productData.comparePrice - productData.price;
        document.getElementById('saveDisplay').textContent = 'Tu √©conomises ' + Utils.formatPrice(saved);
        document.getElementById('saveDisplay').style.display = '';
      }

      // Gallery
      if (productData.images && productData.images.length > 0) {
        allImages = productData.images;
        document.getElementById('mainImage').src = allImages[0];
        document.getElementById('mainImage').alt = productData.name;
        if (allImages.length > 1) {
          document.getElementById('galleryPrev').style.display = '';
          document.getElementById('galleryNext').style.display = '';
        }
        document.getElementById('thumbs').innerHTML = allImages.map((img, i) =>
          `<img src="${Utils.escapeHtml(img)}" alt="" class="sf-thumb ${i === 0 ? 'active' : ''}" onclick="setGalleryImage(${i})">`
        ).join('');
      }

      // Short desc
      if (productData.description) {
        document.getElementById('shortDesc').textContent = productData.description;
        document.getElementById('shortDesc').style.display = '';
        document.getElementById('descriptionSection').style.display = '';
        document.getElementById('descriptionContent').textContent = productData.description;
      }

      // Features
      if (productData.features && productData.features.length > 0) {
        document.getElementById('featuresDisplay').innerHTML = productData.features.map(f =>
          `<div class="sf-feature"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--sf-primary)" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg> ${Utils.escapeHtml(f)}</div>`
        ).join('');
      }

      // Bundles
      if (funnelData?.bundles && funnelData.bundles.length > 0) {
        document.getElementById('bundlesSection').style.display = '';
        document.getElementById('bundlesList').innerHTML = funnelData.bundles.map((b, i) => `
          <div class="sf-bundle-option ${i === 0 ? 'selected' : ''}" onclick="selectBundle(${i})">
            <div class="sf-bundle-radio"></div>
            <div class="sf-bundle-info">
              <strong>${Utils.escapeHtml(b.label)}</strong>
              <span>${b.qty}x ‚Äî ${Utils.formatPrice(b.unitPrice)}/unit√©</span>
            </div>
            <div class="sf-bundle-total">${Utils.formatPrice(b.unitPrice * b.qty)}</div>
            ${b.badge ? `<span class="sf-bundle-badge">${Utils.escapeHtml(b.badge)}</span>` : ''}
          </div>
        `).join('');
        selectedBundle = funnelData.bundles[0];
        updatePrice();
      }

      // Order Bump
      if (funnelData?.orderBump?.title) {
        document.getElementById('bumpSection').style.display = '';
        document.getElementById('bumpTitle').textContent = funnelData.orderBump.title;
        document.getElementById('bumpDesc').textContent = funnelData.orderBump.description || '';
        document.getElementById('bumpPriceDisplay').textContent = '+ ' + Utils.formatPrice(funnelData.orderBump.price);
        document.getElementById('bumpCheckbox').addEventListener('change', (e) => {
          bumpSelected = e.target.checked;
          updatePrice();
        });
      }

      // Countdown
      if (funnelData?.countdownMinutes) startCountdown(funnelData.countdownMinutes);

      // Stock display
      if (productData.stock != null) {
        const stockBadge = document.getElementById('stockBadge');
        stockBadge.style.display = '';
        if (productData.stock <= 0) {
          document.getElementById('stockText').textContent = 'üî¥ Rupture de stock';
          document.getElementById('ctaBtn').disabled = true;
          document.getElementById('ctaBtn').textContent = 'Rupture de stock';
        } else if (productData.stock <= 10) {
          document.getElementById('stockText').textContent = `üî• Plus que ${productData.stock} en stock !`;
        } else {
          document.getElementById('stockText').textContent = `‚úÖ En stock (${productData.stock} disponibles)`;
        }
      }

      // Track view (analytics) ‚Äî skip in preview mode
      if (!isPreviewMode) {
        try { await DB.trackView(storeData.id); } catch(e) {}
      }

      // Show
      document.getElementById('loader').style.display = 'none';
      document.getElementById('productPage').style.display = '';
      document.getElementById('footerYear').textContent = new Date().getFullYear();
    }

    init();
  </script>
</body>
</html>
